{% extends 'base.html.twig' %}

{% block title %}Tableau de Bord{% endblock %}

<<<<<<< HEAD

=======
>>>>>>> 5ee598bdedd1af66da94dbed42760e3c86ee187c
{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.css">
    <style>
        .card {
            margin-bottom: 20px;
        }
<<<<<<< HEAD
=======
        .ticket-list {
            max-height: 600px;
            overflow-y: auto;
        }
>>>>>>> 5ee598bdedd1af66da94dbed42760e3c86ee187c
    </style>
{% endblock %}

{% block body %}
    {{ include('home/partials/header.html.twig') }}

    <div class="container mt-4">
        <h1 class="mb-4">Tableau de Bord</h1>
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Tickets Ouverts</h5>
                        <h2 class="card-text" id="openTickets">{{ openTickets }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">En Cours</h5>
                        <h2 class="card-text" id="inProgressTickets">{{ inProgressTickets }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Résolus Aujourd'hui</h5>
                        <h2 class="card-text" id="resolvedToday">{{ resolvedToday }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Temps Moyen de Résolution</h5>
                        <h2 class="card-text" id="avgResolutionTime">{{ avgResolutionTime }} h</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Tickets Récents</h5>
                        <ul class="list-group" id="recentTickets">
                            {% for ticket in recentTickets %}
                                <li class="list-group-item">{{ ticket.title }} - {{ ticket.date|date("d/m/Y") }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Statistiques des Tickets</h5>
                        <canvas id="ticketStats"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <h1 class="mb-4">Gestion des Tickets</h1>
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">Liste des Tickets</div>
                    <div class="card-body ticket-list">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Titre</th>
                                    <th>Statut</th>
                                    <th>Assigné à</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ticket in tickets %}
                                    <tr>
                                        <td>{{ ticket.id }}</td>
                                        <td>{{ ticket.title }}</td>
                                        <td>
                                            <span class="badge bg-{{ ticket.status == 'Ouvert' ? 'danger' : (ticket.status == 'En cours' ? 'warning' : 'success') }}">
                                                {{ ticket.status }}
                                            </span>
                                        </td>
                                        <td>{{ ticket.assignedTo }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="editTicket({{ ticket.id }})">Éditer</button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">Détails du Ticket</div>
                    <div class="card-body">
                        <form id="ticketForm">
                            <input type="hidden" id="ticketId">
                            <div class="mb-3">
                                <label for="ticketTitle" class="form-label">Titre</label>
                                <input type="text" class="form-control" id="ticketTitle" required>
                            </div>
                            <div class="mb-3">
                                <label for="ticketTitle" class="form-label">Nom du client</label>
                                <input type="text" class="form-control" id="ticketTitle" required>
                            </div>
                            <div class="mb-3">
                                <label for="ticketTitle" class="form-label">Adresse du client</label>
                                <input type="text" class="form-control" id="ticketTitle" required>
                            </div>
                            <div class="mb-3">
                                <label for="ticketTitle" class="form-label">Telephone du client</label>
                                <input type="text" class="form-control" id="ticketTitle" required>
                            </div>
                            <div class="mb-3">
                                <label for="ticketStatus" class="form-label">Statut</label>
                                <select class="form-select" id="ticketStatus" required>
                                    <option value="Ouvert">Ouvert</option>
                                    <option value="En cours">En cours</option>
                                    <option value="Résolu">Résolu</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="ticketAssignedTo" class="form-label">Assigné à</label>
                                <select class="form-select" id="ticketAssignedTo" required>
                                    <option value="">Choisir un technicien</option>
                                    {% for technician in technicians %}
                                        <option value="{{ technician.id }}">{{ technician.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="ticketDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="ticketDescription" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Sauvegarder</button>
                        </form>
                    </div>
                </div>
                <a href="/"><button type="button" class="btn btn-primary">Retour</button></a>
            </div>
        </div>
    </div>

    <div id="notifications" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>
    
{% endblock %}

{% block javascripts %}
    {{ parent() }}
<<<<<<< HEAD
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // Graphique circulaire pour les statistiques des tickets
=======
   
    <script>
        function editTicket(ticketId) {
            console.log("Editing ticket:", ticketId);
            const ticket = {
                id: ticketId,
                title: 'Titre du ticket ' + ticketId,
                status: 'En cours',
                assignedTo: '1',
                description: 'Description du ticket ' + ticketId
            };

            document.getElementById('ticketId').value = ticket.id;
            document.getElementById('ticketTitle').value = ticket.title;
            document.getElementById('ticketStatus').value = ticket.status;
            document.getElementById('ticketAssignedTo').value = ticket.assignedTo;
            document.getElementById('ticketDescription').value = ticket.description;
        }

        document.getElementById('ticketForm').addEventListener('submit', function (e) {
            e.preventDefault();
            alert('Ticket sauvegardé !');
            this.reset();
        });

        document.addEventListener('DOMContentLoaded', function () {
>>>>>>> 5ee598bdedd1af66da94dbed42760e3c86ee187c
            var ctx = document.getElementById('ticketStats').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ouverts', 'En Cours', 'Résolus'],
                    datasets: [{
                        data: [{{ openTickets }}, {{ inProgressTickets }}, {{ resolvedToday }}],
<<<<<<< HEAD
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(75, 192, 192, 0.8)'
                        ]
=======
                        backgroundColor: ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(75, 192, 192, 0.8)']
>>>>>>> 5ee598bdedd1af66da94dbed42760e3c86ee187c
                    }]
                },
                options: {
                    responsive: true,
<<<<<<< HEAD
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: 'Répartition des Tickets'
                    }
                }
            });

            // Simulation de mise à jour en temps réel
            setInterval(function() {
=======
                    legend: { position: 'bottom' },
                    title: { display: true, text: 'Répartition des Tickets' }
                }
            });

            setInterval(function () {
>>>>>>> 5ee598bdedd1af66da94dbed42760e3c86ee187c
                document.getElementById('openTickets').textContent = Math.floor(Math.random() * 50);
                document.getElementById('inProgressTickets').textContent = Math.floor(Math.random() * 30);
                document.getElementById('resolvedToday').textContent = Math.floor(Math.random() * 20);
                document.getElementById('avgResolutionTime').textContent = (Math.random() * 24).toFixed(1) + ' h';
            }, 5000);
        });
<<<<<<< HEAD
    </script>
=======

        function showNotification(message, type = 'info') {
            const notificationElement = document.createElement('div');
            notificationElement.className = `alert alert-${type} alert-dismissible fade show`;
            notificationElement.role = 'alert';
            notificationElement.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.getElementById('notifications').appendChild(notificationElement);

            setTimeout(() => {
                notificationElement.remove();
            }, 5000);
        }

        const eventSource = new EventSource("{{ mercure('https://example.com/notifications')|escape('js') }}");
        eventSource.onmessage = event => {
            const data = JSON.parse(event.data);
            showNotification(data.message, data.type === 'stock_alert' ? 'warning' : 'info');
        };

        function checkStock() {
            fetch('/stock-alert', { method: 'POST' }).then(response => response.json()).then(data => {
                if (data.success) { 
                    // La notification sera gérée par le EventSource
                }
            });
        }

        setInterval(checkStock, 30000);
    </script>

>>>>>>> 5ee598bdedd1af66da94dbed42760e3c86ee187c
{% endblock %}
