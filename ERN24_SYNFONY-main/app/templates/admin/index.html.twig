{% extends 'base.html.twig' %}

{% block title %}TR | Admin dashboard{% endblock %}

{% block body %}
    {{ include('home/partials/header.html.twig') }}

    <div class="container mt-5">
        <div class="card">
            <div class="card-header">
                <h1>Admin Dashboard</h1>
            </div>
            <div class="card-body">
                {% if app.user %}
                    <p>Welcome, <strong>{{ app.user.email }}</strong>! You have the following roles: <strong>{{ app.user.roles|join(', ') }}</strong></p>
                    <a href="{{ path('admin_catalogue')}}" class="btn btn-primary mb-3">Catalogue de pièces</a>
                    <a href="{{ path('supplier_list')}}" class="btn btn-primary mb-3">Supplier list</a>

                    <h2>Users</h2>
                    <ul class="list-group mb-3">
                        {% for user in users %}
                            <li class="list-group-item">{{ user.email }} - Roles: {{ user.roles|join(', ') }}</li>
                        {% endfor %}
                    </ul>

                    <h2>Tickets</h2>
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Description</th>
                            <th>Date de Début</th>
                            <th>Date de Fin</th>
                            <th>Statut</th>
                            <th>Assigné à</th>
                            <th>Intervention</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for ticket in tickets %}
                            <tr>
                                <td>{{ ticket.id }}</td>
                                <td>{{ ticket.description }}</td>
                                <td>{{ ticket.dateStart|date('d/m/Y H:i') }}</td>
                                <td>{{ ticket.dateEnd|date('d/m/Y H:i') }}</td>
                                <td>{{ ticket.status }}</td>
                                <td>{{ ticket.technicien ? ticket.technicien.email : 'Non assigné' }}</td>
                                <td>{{ ticket.intervention ? ticket.intervention.label : 'Non assigné' }}</td>
                                <td>
                                    <form method="post" action="{{ path('admin_assign_ticket', {id: ticket.id}) }}">
                                        <select name="technician_id" class="form-select">
                                            <option value="">Choisir un technicien</option>
                                            {% for technician in technicians %}
                                                <option value="{{ technician.id }}" {% if ticket.technicien and ticket.technicien.id == technician.id %}selected{% endif %}>
                                                    {{ technician.email }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-primary mt-2">Assigner</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                    <h2>Supply</h2>
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Label</th>
                            <th>Reference number</th>
                            <th>Quantity</th>
                            <th>Active</th>
                            <th>Supplier</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for stock in stocks %}
                            <tr>
                                <td>{{ stock.id }}</td>
                                <td>{{ stock.label }}</td>
                                <td>{{ stock.referenceNb }}</td>
                                <td>{{ stock.quantity }}</td>
                                <td>{{ stock.isActive ? 'Yes' : 'No' }}</td>
                                <td>{{ stock.supplier ? stock.supplier.email : 'No supplier' }}</td>
                                <td>
                                    <form method="post" action="{{ path('admin_assign_supplier', {id: stock.id}) }}">
                                        <select name="supplier_id" class="form-select">
                                            <option value="">Choisir un fournisseur</option>
                                            {% for supplier in suppliers %}
                                                <option value="{{ supplier.id }}" {% if stock.supplier and stock.supplier.id == supplier.id %}selected{% endif %}>
                                                    {{ supplier.email }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-primary mt-2">Assigner</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                    <h2>Request Stock</h2>
                    <form class="table">
                        <div class="mb-3">
                            <label for="label" class="form-label">{{ form_label(form.label) }}:</label>
                            {{ form_widget(form.label, {'attr': {'class': 'form-control'}}) }}
                        </div>
                        <div class="mb-3">
                            <label for="referenceNb" class="form-label">{{ form_label(form.referenceNb) }}:</label>
                            {{ form_widget(form.referenceNb, {'attr': {'class': 'form-control'}}) }}
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">{{ form_label(form.quantity) }}:</label>
                            {{ form_widget(form.quantity, {'attr': {'class': 'form-control'}}) }}
                        </div>
                        <div class="mb-3">
                            <label for="isActive" class="form-label">{{ form_label(form.isActive) }}:</label>
                            <div class="form-check form-switch d-inline-block">
                                {{ form_widget(form.isActive, {'attr': {'class': 'form-check-input form-check-input-lg'}}) }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="supplier" class="form-label">{{ form_label(form.supplier) }}:</label>
                            {{ form_widget(form.supplier, {'attr': {'class': 'form-select'}}) }}
                        </div>
                        <button type="submit" class="btn btn-primary">Add Stock</button>
                    </form>
                    {{ form_end(form) }}

                    <div class="text-end mt-3">
                        <form action="{{ path('app_logout') }}" method="post">
                            <button type="submit" class="btn btn-danger">Logout</button>
                        </form>
                    </div>

                {% else %}
                    <p>You are not logged in.</p>
                    <a href="{{ path('app_login') }}" class="btn btn-primary">Login</a>
                {% endif %}
            </div>
        </div>
    </div>
    {{ include('home/partials/footer.html.twig') }}
{% endblock %}
